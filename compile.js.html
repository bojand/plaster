<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Plaster</title>
    
    <meta name="description" content="Simple Mongoose-inspired schema based Javascript object modelling" />
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"Plaster","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"Plaster","description":"Simple Mongoose-inspired schema based Javascript object modelling","keyword":""},"linenums":true};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Plaster</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">

    
        <li class="item" data-name="Model">
            <span class="title">
                <a href="Model.html">Model</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="Model#modelName"><a href="Model.html#modelName">modelName</a></li>
            
                <li data-name="Model#schema"><a href="Model.html#schema">schema</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Model#clear"><a href="Model.html#clear">clear</a></li>
            
                <li data-name="Model#clearErrors"><a href="Model.html#clearErrors">clearErrors</a></li>
            
                <li data-name="Model#getErrors"><a href="Model.html#getErrors">getErrors</a></li>
            
                <li data-name="Model#hasErrors"><a href="Model.html#hasErrors">hasErrors</a></li>
            
                <li data-name="Model#inspect"><a href="Model.html#inspect">inspect</a></li>
            
                <li data-name="Model#set"><a href="Model.html#set">set</a></li>
            
                <li data-name="Model#toJSON"><a href="Model.html#toJSON">toJSON</a></li>
            
                <li data-name="Model#toObject"><a href="Model.html#toObject">toObject</a></li>
            
                <li data-name="Model#toString"><a href="Model.html#toString">toString</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="ModelArray">
            <span class="title">
                <a href="ModelArray.html">ModelArray</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="ModelInstance">
            <span class="title">
                <a href="ModelInstance.html">ModelInstance</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="ModelInstance.modelName"><a href="ModelInstance.html#.modelName">modelName</a></li>
            
                <li data-name="ModelInstance.schema"><a href="ModelInstance.html#.schema">schema</a></li>
            
                <li data-name="ModelInstance#modelName"><a href="ModelInstance.html#modelName">modelName</a></li>
            
                <li data-name="ModelInstance#schema"><a href="ModelInstance.html#schema">schema</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="ModelInstance#clear"><a href="ModelInstance.html#clear">clear</a></li>
            
                <li data-name="ModelInstance#clearErrors"><a href="ModelInstance.html#clearErrors">clearErrors</a></li>
            
                <li data-name="ModelInstance#getErrors"><a href="ModelInstance.html#getErrors">getErrors</a></li>
            
                <li data-name="ModelInstance#hasErrors"><a href="ModelInstance.html#hasErrors">hasErrors</a></li>
            
                <li data-name="ModelInstance#inspect"><a href="ModelInstance.html#inspect">inspect</a></li>
            
                <li data-name="ModelInstance#set"><a href="ModelInstance.html#set">set</a></li>
            
                <li data-name="ModelInstance#toJSON"><a href="ModelInstance.html#toJSON">toJSON</a></li>
            
                <li data-name="ModelInstance#toObject"><a href="ModelInstance.html#toObject">toObject</a></li>
            
                <li data-name="ModelInstance#toString"><a href="ModelInstance.html#toString">toString</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Plaster">
            <span class="title">
                <a href="Plaster.html">Plaster</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="Plaster#Model"><a href="Plaster.html#Model">Model</a></li>
            
                <li data-name="Plaster#ModelArray"><a href="Plaster.html#ModelArray">ModelArray</a></li>
            
                <li data-name="Plaster#Plaster"><a href="Plaster.html#Plaster">Plaster</a></li>
            
                <li data-name="Plaster#Schema"><a href="Plaster.html#Schema">Schema</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Plaster#get"><a href="Plaster.html#get">get</a></li>
            
                <li data-name="Plaster#getModel"><a href="Plaster.html#getModel">getModel</a></li>
            
                <li data-name="Plaster#model"><a href="Plaster.html#model">model</a></li>
            
                <li data-name="Plaster#modelNames"><a href="Plaster.html#modelNames">modelNames</a></li>
            
                <li data-name="Plaster#schema"><a href="Plaster.html#schema">schema</a></li>
            
                <li data-name="Plaster#set"><a href="Plaster.html#set">set</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Schema">
            <span class="title">
                <a href="Schema.html">Schema</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Schema#add"><a href="Schema.html#add">add</a></li>
            
                <li data-name="Schema#extend"><a href="Schema.html#extend">extend</a></li>
            
                <li data-name="Schema#get"><a href="Schema.html#get">get</a></li>
            
                <li data-name="Schema#method"><a href="Schema.html#method">method</a></li>
            
                <li data-name="Schema#post"><a href="Schema.html#post">post</a></li>
            
                <li data-name="Schema#pre"><a href="Schema.html#pre">pre</a></li>
            
                <li data-name="Schema#queue"><a href="Schema.html#queue">queue</a></li>
            
                <li data-name="Schema#set"><a href="Schema.html#set">set</a></li>
            
                <li data-name="Schema#static"><a href="Schema.html#static">static</a></li>
            
                <li data-name="Schema#virtual"><a href="Schema.html#virtual">virtual</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="compile.js.html">Source: compile.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const _ = require('lodash');
const hooks = require('hooks-fixed');

import _privateKey from './privatekey'
import { Model } from './model'
import { Schema } from './schema'

/**
 * Compiles a schema into a Model
 * @param descriptor
 * @param options
 * @param name
 * @returns {ModelInstance}
 * @private
 */
export function compile(descriptor, options = {}, name = undefined) {

  var schema = descriptor;
  if (!(schema instanceof Schema)) {
    schema = new Schema(schema, options);
  }

  // Some of the options require the reflection.
  if (typeof(Proxy) === 'undefined') {

    // If strict mode is off but the --harmony flag is not, fail.
    if (!options.strict) {
      throw new Error('Turning strict mode off requires --harmony flag.');
    }

    // If dot notation is on but the --harmony flag is not, fail.
    if (options.dotNotation) {
      throw new Error('Dot notation support requires --harmony flag.');
    }
  }

  /**
   * ModelInstance class is the compiled class from a schema definition. It extends &lt;code>Model&lt;/code>.
   * All models generated are an instance of ModelInstance. It also inherits &lt;code>hooks-fixed&lt;/code>
   * See {@link https://www.npmjs.com/package/hooks-fixed hooks-fixed} for pre and post hooks.
   * @class
   * @augments Model
   *
   */
  class ModelInstance extends Model {
    /**
     * This would be the constructor for the generated models.
     * @param {Object} data - the model instance data
     * @param {Object} options - optional creation options
     * @param {Boolean} options.clone - Whether to deep clone the incoming data. Default: &lt;code>false&lt;/code>.
     *                                  Make sure you wish to do this as it has performance implications. This is
     *                                  useful if you are creating multiple instances from same base data and then
     *                                  wish to modify each instance.
     *
     */
    constructor(data, options = {}) {
      super(data, options, schema, name);
    }
  }

  var k;
  for (k in hooks) {
    ModelInstance.prototype[k] = ModelInstance[k] = hooks[k];
  }

  /**
   * @name schema
   * @static {Schema}
   * @memberof ModelInstance
   * @description Schema the schema of this model.
   */
  ModelInstance.schema = schema;

  /**
   * @name modelName
   * @static {String}
   * @memberof ModelInstance
   * @description The name of the model.
   */
  ModelInstance.modelName = name;

  // Add custom methods to generated class.
  _.each(schema.methods, (method, key) => {
    if (ModelInstance.prototype[key]) {
      throw new Error(`Cannot overwrite existing ${key} method with custom method.`);
    }
    ModelInstance.prototype[key] = method;
  });

  // Add custom static methods to generated class.
  _.each(schema.statics, (method, key) => {
    if (ModelInstance[key]) {
      throw new Error(`Cannot overwrite existing ${key} static with custom method.`);
    }
    ModelInstance[key] = method;
  });

  setupHooks(ModelInstance);

  // if the user wants to allow modifications
  if (options.freeze !== false) Object.freeze(ModelInstance);

  return ModelInstance;
}

/*!
 * Sets up hooks for the new Model
 * @param InstanceModel
 */
function setupHooks(InstanceModel) {
  // set up hooks
  var ourHookedFnNames = ['save', 'remove'];
  ourHookedFnNames.forEach(function (fnName) {
    InstanceModel.hook(fnName, InstanceModel.prototype[fnName]);
  });

  var q = InstanceModel.schema &amp;&amp; InstanceModel.schema.callQueue;

  if (q) {
    for (var i = 0, l = q.length; i &lt; l; i++) {
      var hookFn = q[i].hook;
      var args = q[i].args;

      var hookedFnName = args[0];
      if (ourHookedFnNames.indexOf(hookedFnName) === -1) {
        InstanceModel.hook(hookedFnName, InstanceModel.prototype[hookedFnName]);
      }

      function wrapPostHook(fnArgs, index) {
        var mwfn = fnArgs[index];

        function hookCb(next) {
          mwfn.apply(this);
          next(undefined, this);
        }

        fnArgs[index] = hookCb;
      }

      // wrap post
      if (hookFn === 'post' &amp;&amp; ourHookedFnNames.indexOf(hookedFnName) >= 0) {
        if (args.length === 2 &amp;&amp; typeof args[1] === 'function') {
          wrapPostHook(args, 1);
        }
        else if (args.length === 3 &amp;&amp; typeof args[2] === 'function') {
          wrapPostHook(args, 2);
        }
      }

      InstanceModel[hookFn].apply(InstanceModel, args);
    }
  }
}</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Feb 11 2016 09:05:52 GMT-0400 (AST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
