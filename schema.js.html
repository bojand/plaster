<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Plaster</title>
    
    <meta name="description" content="Simple Mongoose-inspired schema based Javascript object modelling" />
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"Plaster","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"Plaster","description":"Simple Mongoose-inspired schema based Javascript object modelling","keyword":""},"linenums":true};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Plaster</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">

    
        <li class="item" data-name="Model">
            <span class="title">
                <a href="Model.html">Model</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="Model#modelName"><a href="Model.html#modelName">modelName</a></li>
            
                <li data-name="Model#schema"><a href="Model.html#schema">schema</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Model#clear"><a href="Model.html#clear">clear</a></li>
            
                <li data-name="Model#clearErrors"><a href="Model.html#clearErrors">clearErrors</a></li>
            
                <li data-name="Model#getErrors"><a href="Model.html#getErrors">getErrors</a></li>
            
                <li data-name="Model#hasErrors"><a href="Model.html#hasErrors">hasErrors</a></li>
            
                <li data-name="Model#inspect"><a href="Model.html#inspect">inspect</a></li>
            
                <li data-name="Model#set"><a href="Model.html#set">set</a></li>
            
                <li data-name="Model#toJSON"><a href="Model.html#toJSON">toJSON</a></li>
            
                <li data-name="Model#toObject"><a href="Model.html#toObject">toObject</a></li>
            
                <li data-name="Model#toString"><a href="Model.html#toString">toString</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="ModelArray">
            <span class="title">
                <a href="ModelArray.html">ModelArray</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="ModelInstance">
            <span class="title">
                <a href="ModelInstance.html">ModelInstance</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="ModelInstance.modelName"><a href="ModelInstance.html#.modelName">modelName</a></li>
            
                <li data-name="ModelInstance.schema"><a href="ModelInstance.html#.schema">schema</a></li>
            
                <li data-name="ModelInstance#modelName"><a href="ModelInstance.html#modelName">modelName</a></li>
            
                <li data-name="ModelInstance#schema"><a href="ModelInstance.html#schema">schema</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="ModelInstance#clear"><a href="ModelInstance.html#clear">clear</a></li>
            
                <li data-name="ModelInstance#clearErrors"><a href="ModelInstance.html#clearErrors">clearErrors</a></li>
            
                <li data-name="ModelInstance#getErrors"><a href="ModelInstance.html#getErrors">getErrors</a></li>
            
                <li data-name="ModelInstance#hasErrors"><a href="ModelInstance.html#hasErrors">hasErrors</a></li>
            
                <li data-name="ModelInstance#inspect"><a href="ModelInstance.html#inspect">inspect</a></li>
            
                <li data-name="ModelInstance#set"><a href="ModelInstance.html#set">set</a></li>
            
                <li data-name="ModelInstance#toJSON"><a href="ModelInstance.html#toJSON">toJSON</a></li>
            
                <li data-name="ModelInstance#toObject"><a href="ModelInstance.html#toObject">toObject</a></li>
            
                <li data-name="ModelInstance#toString"><a href="ModelInstance.html#toString">toString</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Plaster">
            <span class="title">
                <a href="Plaster.html">Plaster</a>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="Plaster#Model"><a href="Plaster.html#Model">Model</a></li>
            
                <li data-name="Plaster#ModelArray"><a href="Plaster.html#ModelArray">ModelArray</a></li>
            
                <li data-name="Plaster#Plaster"><a href="Plaster.html#Plaster">Plaster</a></li>
            
                <li data-name="Plaster#Schema"><a href="Plaster.html#Schema">Schema</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Plaster#get"><a href="Plaster.html#get">get</a></li>
            
                <li data-name="Plaster#getModel"><a href="Plaster.html#getModel">getModel</a></li>
            
                <li data-name="Plaster#model"><a href="Plaster.html#model">model</a></li>
            
                <li data-name="Plaster#modelNames"><a href="Plaster.html#modelNames">modelNames</a></li>
            
                <li data-name="Plaster#schema"><a href="Plaster.html#schema">schema</a></li>
            
                <li data-name="Plaster#set"><a href="Plaster.html#set">set</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Schema">
            <span class="title">
                <a href="Schema.html">Schema</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Schema#add"><a href="Schema.html#add">add</a></li>
            
                <li data-name="Schema#extend"><a href="Schema.html#extend">extend</a></li>
            
                <li data-name="Schema#get"><a href="Schema.html#get">get</a></li>
            
                <li data-name="Schema#method"><a href="Schema.html#method">method</a></li>
            
                <li data-name="Schema#post"><a href="Schema.html#post">post</a></li>
            
                <li data-name="Schema#pre"><a href="Schema.html#pre">pre</a></li>
            
                <li data-name="Schema#queue"><a href="Schema.html#queue">queue</a></li>
            
                <li data-name="Schema#set"><a href="Schema.html#set">set</a></li>
            
                <li data-name="Schema#static"><a href="Schema.html#static">static</a></li>
            
                <li data-name="Schema#virtual"><a href="Schema.html#virtual">virtual</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="schema.js.html">Source: schema.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const _ = require('lodash');
const clone = require('clone');

import { normalizeProperties } from './normalize'

export class Schema {
  /**
   * @classdesc Schema class represents the schema definition. It includes properties, methods, static methods, and any
   * middleware we want to define.
   *
   * @description Creates an object schema
   * @class
   * @api public
   * @param {Object} descriptor
   * @param {Object} options
   * @param {Boolean} options.strict - By default (&lt;code>true&lt;/code>), allow only values in the schema to be set.
   *                                   When this is &lt;code>false&lt;/code>, setting new fields will dynamically add the field
   *                                   to the schema as type "any".
   * @param {Boolean} options.dotNotation - Allow fields to be set via dot notation. Default: &lt;code>true&lt;/code>.
   *                                      &lt;code>obj['user.name'] = 'Joe'; -> obj: { user: 'Joe' }&lt;code>
   *
   * @param {Boolean} options.minimize - "minimize" schemas by removing empty objects. Default: &lt;code>true&lt;/code>
   * @param {Object} options.toObject - &lt;code>toObject&lt;/code> method options.
   * @param {Boolean} options.toObject.minimize - "minimize" schemas by removing empty objects. Default: &lt;code>true&lt;/code>
   * @param {Function} options.toObject.transform - transform function
   * @param {Boolean} options.toObject.virtuals - whether to include virtual properties. Default: &lt;code>false&lt;/code>
   * @param {Boolean} options.toObject.dateToISO - convert dates to string in ISO format using &lt;code>Date.toISOString()&lt;/code>. Default:  &lt;code>false&lt;/code>
   * @param {Object} options.toJSON - options for &lt;code>toJSON&lt;/code> method options, similar to above
   * @param {Boolean} options.strict - ensures that value passed in ot assigned that were not specified in our
   *                                   schema do not get saved
   * @param {Function} options.onBeforeValueSet - function called when write operations on an object takes place. Currently,
   * it will only notify of write operations on the object itself and will not notify you when child objects are written to.
   * If you return false or throw an error within the onBeforeValueSet handler, the write operation will be cancelled.
   * Throwing an error will add the error to the error stack.
   * @param {Function} options.onValueSet - Similar to &lt;code>onBeforeValueSet&lt;/code>, but called after we've set a value on the key,
   *
   * @example
   * var schema = new plaster.Schema({ name: String });
   * @example &lt;caption>with &lt;code>onBeforeValueSet&lt;/code>&lt;/caption>
   * var User = plaster.schema({ name: String }, {
   *   onBeforeValueSet: function(key, value) {
   *     if(key === 'name' &amp;&amp; value.indexOf('Joe') >= 0) {
   *       return false;
   *     });
   *   }
   * });
   *
   * var User = plaster.model('User', schema);
   * var user = new User();
   * user.name = 'Bill'; // name not set
   * user.name = 'Joe Smith'; //  { name: 'Joe Smith' }
   */
  constructor(descriptor, options = {}) {
    // Create object for options if doesn't exist and merge with defaults.
    this.options = _.extend({
      strict: true,
      dotNotation: true
    }, options);

    this.methods = {};
    this.statics = {};
    this.callQueue = [];

    this.add(descriptor);
  }

  /**
   * Creates a instance method for the created model.
   * An object of function names and functions can also be passed in.
   *
   * @api public
   * @param {String} name the name of the method
   * @param {Function} func the actual function implementation
   *
   * @example
   * var userSchema = plaster.schema({
   *   firstName: String,
   *   lastName: String
   * });
   *
   * userSchema.method('getFullName', function () {
   *   return this.firstName + ' ' + this.lastName
   * });
   *
   * var User = plaster.model('User', userSchema);
   * var user = new User({
   *   firstName: 'Joe',
   *   lastName: 'Smith'
   * });
   *
   * console.log(user.getFullName()); // Joe Smith
   *
   */
  method(name, func) {
    if (_.isPlainObject(name)) {
      for (func in name) {
        this.method(func, name[func]);
      }
    }
    else {
      if (!_.isString(name)) throw new TypeError('Schema#method expects a string identifier as a function name');
      else if (!_.isFunction(func)) throw new TypeError('Schema#method expects a function as a handle');

      this.methods[name] = func;
    }
  }

  /**
   * Creates a static function for the created model.
   * An object of function names and functions can also be passed in.
   *
   * @api public
   * @param {String} name name of the statuc function
   * @param {Function} func the actual function
   *
   * * @example
   * var userSchema = plaster.schema({ name: String });
   *
   * userSchema.static('foo', function () {
   *   return 'bar';
   * });
   *
   * var User = plaster.model('User', userSchema);
   *
   * console.log(User.foo()); // 'bar'
   *
   */
  static(name, func) {
    if (_.isPlainObject(name)) {
      for (func in name) {
        this.statics(func, name[func]);
      }
    }
    else {
      if (!_.isString(name)) throw new TypeError('Schema#statics expects a string identifier as a function name');
      else if (!_.isFunction(func)) throw new TypeError('Schema#statics expects a function as a handle');

      this.statics[name] = func;
    }
  }

  /**
   * Creates a virtual property for the created model with the given object
   * specifying the get and optionally set function
   *
   * @api public
   * @param {String} name name of the virtual property
   * @param {String|Function|Object} type optional type to be used for the virtual property. If not provided default is
   *                                      'any' type.
   * @param {Object} options virtual options
   * @param {Function} options.get - the virtual getter function
   * @param {Function} options.set - the virtual setter function. If not provided the virtual becomes read-only.
   *
   * @example
   * var userSchema = plaster.schema({firstName: String, lastName: String});
   *
   * userSchema.virtual('fullName', String, {
   *   get: function () {
   *     return this.firstName + ' ' + this.lastName;
   *   },
   *   set: function (v) {
   *     if (v !== undefined) {
   *       var parts = v.split(' ');
   *       this.firstName = parts[0];
   *       this.lastName = parts[1];
   *     }
   *   }
   * });
   *
   * var User = plaster.model('User', userSchema);
   *
   * var user = new User({firstName: 'Joe', lastName: 'Smith'});
   * console.log(user.fullName); // Joe Smith
   * user.fullName = 'Bill Jones';
   * console.log(user.firstName); // Bill
   * console.log(user.lastName); // Jones
   * console.log(user.fullName); // Bill Jones
   */
  virtual(name, type, options) {
    if (!_.isString(name)) throw new TypeError('Schema#virtual expects a string identifier as a property name');

    if (_.isPlainObject(type) &amp;&amp; !options) {
      options = type;
      type = 'any';
    }

    else if (!_.isPlainObject(options)) throw new TypeError('Schema#virtual expects an object as a handle');
    else if (!_.isFunction(options.get)) throw new TypeError('Schema#virtual expects an object with a get function');

    var virtualType = {
      type: type,
      virtual: true,
      get: options.get,
      invisible: true
    };

    if (options.set) {
      virtualType.set = options.set;
    }
    else {
      virtualType.readOnly = true;
    }

    this.descriptor[name] = virtualType;
  }

  /**
   * Sets/gets a schema option.
   *
   * @param {String} key option name
   * @param {Object} [value] if not passed, the current option value is returned
   * @api public
   */
  set(key, value) {
    if (1 === arguments.length) {
      return this.options[key];
    }

    this.options[key] = value;

    return this;
  }

  /**
   * Gets a schema option.
   *
   * @api public
   * @param {String} key option name
   * @return {*} the option value
   */
  get(key) {
    return this.options[key];
  }

  /**
   * Defines a pre hook for the schema.
   * See {@link https://www.npmjs.com/package/hooks-fixed hooks-fixed}.
   */
  pre() {
    return this.queue('pre', arguments);
  }

  /**
   * Defines a post hook for the schema.
   * See {@link https://www.npmjs.com/package/hooks-fixed hooks-fixed}.
   */
  post() {
    return this.queue('post', arguments);
  }

  /**
   * Adds a method call to the queue.
   *
   * @param {String} name name of the document method to call later
   * @param {Array} args arguments to pass to the method
   * @api private
   */
  queue(name, args) {
    var q = {hook: name, args: args};
    if (args[0] &amp;&amp; typeof args[0] === 'string') {
      q.hooked = args[0];
    }

    this.callQueue.push(q);
  }

  /**
   * Adds the descriptor to the schema at the given key
   * @param key the property key
   * @param descriptor the property descriptor
   *
   * @example
   * var userSchema = plaster.schema({firstName: String });
   * userSchema.add('lastName', String);
   */
  add(key, descriptor) {
    if (!this.descriptor) {
      this.descriptor = {};
    }

    // adjust our descriptor
    if (key &amp;&amp; descriptor) {
      this.descriptor[key] = normalizeProperties.call(this, descriptor, key)
    }
    else if (typeof key === 'object' &amp;&amp; !descriptor) {
      if (!this.descriptor) {
        this.descriptor = {};
      }

      _.each(key, (properties, index) => {
        this.descriptor[index] = normalizeProperties.call(this, properties, index);
      });
    }
  }

  /**
   * Clones property from other to us
   * @param {Schema} other - other schema
   * @param {String} prop - property name
   * @param {Boolean} add - whether to add() or assign. if true will do deep clone.
   * @private
   */
  _cloneProp(other, prop, add) {
    if (other &amp;&amp; other[prop]) {
      let p;
      for (p in other[prop]) {
        if (other[prop].hasOwnProperty(p) &amp;&amp; !this[prop][p]) {
          if (add) {
            this.add(p, clone(other.descriptor[p]));
          }
          else {
            this[prop][p] = other[prop][p];
          }
        }
      }
    }
  }

  /**
   * Extends other schema. Copies descriptor properties, methods, statics, virtuals and middleware.
   * If this schema has a named property already, the property is not copied.
   * @param {Schema} other the schema to extend.
   */
  extend(other) {
    if (other &amp;&amp; other instanceof Schema) {
      this._cloneProp(other, 'descriptor', true);
      this._cloneProp(other, 'statics');
      this._cloneProp(other, 'methods');

      var self = this;
      other.callQueue.forEach(function (e) {
        self.callQueue.unshift(e);
      });
    }

    return this;
  }
}</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Feb 11 2016 08:58:26 GMT-0400 (AST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
